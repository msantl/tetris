#include "misc.h"

char area[][17] =
{
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##|          |##",
  "##------------##",
  "################",
};

char shapes[][4][4][4] = 
{
  {
    {
      {'#','#','#','#'},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ','#',' ',' '},
      {' ','#',' ',' '},
      {' ','#',' ',' '},
      {' ','#',' ',' '},
    },
    {
      {'#','#','#','#'},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ','#',' ',' '},
      {' ','#',' ',' '},
      {' ','#',' ',' '},
      {' ','#',' ',' '},
    }
  },
  { 
    {
      {' ',' ','#',' '},
      {' ',' ','#',' '},
      {' ','#','#',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ','#',' ',' '},
      {' ','#','#','#'},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ','#','#',' '},
      {' ','#',' ',' '},
      {' ','#',' ',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ','#','#','#'},
      {' ',' ',' ','#'},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
  },
  {
    {
      {' ','#',' ',' '},
      {' ','#',' ',' '},
      {' ','#','#',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ','#','#','#'},
      {' ','#',' ',' '},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ','#','#',' '},
      {' ',' ','#',' '},
      {' ',' ','#',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ',' ',' ','#'},
      {' ','#','#','#'},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
    
  },
  {
    {
      {' ','#','#',' '},
      {' ','#','#',' '},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ','#','#',' '},
      {' ','#','#',' '},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ','#','#',' '},
      {' ','#','#',' '},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ','#','#',' '},
      {' ','#','#',' '},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
    
  },
  {
    {
      {' ','#','#',' '},
      {' ',' ','#','#'},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ',' ','#',' '},
      {' ','#','#',' '},
      {' ','#',' ',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ','#','#',' '},
      {' ',' ','#','#'},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ',' ','#',' '},
      {' ','#','#',' '},
      {' ','#',' ',' '},
      {' ',' ',' ',' '},
    },
    
  },
  {
    {
      {' ',' ','#',' '},
      {' ','#','#','#'},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ',' ','#',' '},
      {' ',' ','#','#'},
      {' ',' ','#',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ',' ',' ',' '},
      {' ','#','#','#'},
      {' ',' ','#',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ',' ','#',' '},
      {' ','#','#',' '},
      {' ',' ','#',' '},
      {' ',' ',' ',' '},
    },
  },
  {
    {
      {' ',' ','#','#'},
      {' ','#','#',' '},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ','#',' ',' '},
      {' ','#','#',' '},
      {' ',' ','#',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ',' ','#','#'},
      {' ','#','#',' '},
      {' ',' ',' ',' '},
      {' ',' ',' ',' '},
    },
    {
      {' ','#',' ',' '},
      {' ','#','#',' '},
      {' ',' ','#',' '},
      {' ',' ',' ',' '},
    },    
  }
};


void sleep_t( double t ){
    int x = (int)(t * 1000000);
    while( (x = usleep(x)) );
    return;
}

int get_random( int lo, int hi ){
  return lo + rand() % ( hi - lo + 1 );  
}

int can_rotate( struct shape *s ){
  int i, j;
  char ch;
  
  
  for( i = 0; i < 4; ++i ){
    for( j = 0; j < 4; ++j ){
      ch = shapes[ s->id ][ s->rot ][i][j];
      if( ch != '#' )continue;
      if( area[i + offY + s->y ][j + offX + s->x] != ' ' )return 0;
    }
  }
  return 1;
}

int can_move_down( struct shape *s ){
  int i, j;
  char ch;
  
  
  for( i = 0; i < 4; ++i ){
    for( j = 0; j < 4; ++j ){
      ch = shapes[ s->id ][ s->rot ][i][j];
      if( ch != '#' )continue;
      if( area[i + offY + s->y + 1][j + offX + s->x] != ' ' )return 0;
    }
  }
  return 1;
}

int can_move_right( struct shape *s ){
  int i, j;
  char ch;
  
  for( i = 0; i < 4; ++i ){
    for( j = 0; j < 4; ++j ){
      ch = shapes[ s->id ][ s->rot ][i][j];
      if( ch == '#' && area[i + offY + s->y][j + offX + s->x + 1] != ' ' )return 0;
    }
  }
  return 1;
}

int can_move_left( struct shape *s ){
  int i, j;
  char ch;
  
  for( i = 0; i < 4; ++i ){
    for( j = 0; j < 4; ++j ){
      ch = shapes[ s->id ][ s->rot ][i][j];
      if( ch == '#' && area[i + offY + s->y + 1][j + offX + s->x - 1] != ' ' )return 0;
    }
  }
  return 1;
}

void add_to_area( struct shape *s ){
  int i, j;
  char ch;
  
  for( i = 0; i < 4; ++i ){
    for( j = 0; j < 4; ++j ){
      ch = shapes[ s->id ][ s->rot ][i][j];
      if( ch == '#' ){
        area[ s->y + offY + i ][ s->x + offX + j ] = '#';
      }
    }
  }
  return;
}

int game_over( struct shape *s ){
  if( can_move_down( s ) == 0 && s->y < 4 )return 1;  
  return 0;
  }

int check_area( void ){
  int ret = 0;
  int i, j, flag;
  for( i = 0; i < areaY -1; ++i ){
    flag = 1;
    for( j = 1; j < areaX - 1; ++j ){
      if( area[i + offY][j + offX] != '#' )flag = 0;
    }
    
    if( flag ){
    
      ret *= 2;
      ret += 100;
      
      for( j = i; j > 0; --j )
        strcpy( area[j + offY], area[j + offY - 1] );
      
      for( j = 1; j < areaX - 1; ++j )
        area[offY][j + offX] = ' ';
    }
    
  }
  return ret;
}

void draw_shape( struct shape *s ){
  int i, j;
  char ch;
  
  for(i = 0; i < 4; ++i){
    for( j = 0; j < 4; ++j ){
      ch = shapes[ s->id ][ s->rot ][i][j];
      if( ch == '#' ){
        move( startY + s->y + i, startX + s->x + j );
        addch( ch );
      }
    }
  }
  
}

void draw_area( void ){
  int i, j;
  
  move( startY, startX );
  
  for(i = 0; i < areaY; ++i){
    for( j = 0; j < areaX; ++j ){
      addch( area[i + offY][j + offX] );
    }
    move( i + startY, startX );
  }
  
  move( maxY - 1, startX );
  printw( "Score: %d", score );
  
  return;
}

void get_next_shape( struct shape *s ){
  s->x = 4;
  s->y = 0;
  s->rot = 0;
  s->id = get_random( 0, 6 );
}
